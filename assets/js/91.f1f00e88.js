(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{449:function(t,e,r){"use strict";r.r(e);var a=r(15),_=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("前置阅读：")]),t._v(" "),e("p",[t._v("① 阅读 "),e("RouterLink",{attrs:{to:"/pay/build/"}},[t._v("《支付功能开启》")]),t._v(" 和 "),e("RouterLink",{attrs:{to:"/pay/alipay-transfer-demo/"}},[t._v("《支付宝转账接入》")]),t._v(" 文档，一定要先跑通支付宝转账流程！！！不跑通支付宝，微信转账更跑不通。")],1),t._v(" "),e("p",[t._v("② 阅读 "),e("a",{attrs:{href:"/mall/trade-brokerage"}},[t._v("《商城手册 —— 【交易】分销返佣》")]),t._v(" 文档，整体流程跑下，因为使用它作为微信转账的示例。")]),t._v(" "),e("p",[t._v("③ 阅读 "),e("a",{attrs:{href:"https://pay.weixin.qq.com/doc/v3/merchant/4012711988",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信商家转账"),e("OutboundLink")],1),t._v(" 的文档，特别是 "),e("a",{attrs:{href:"https://pay.weixin.qq.com/doc/v3/merchant/4012716434",target:"_blank",rel:"noopener noreferrer"}},[t._v("《微信转账 —— 发起转账》"),e("OutboundLink")],1),t._v(" 和 "),e("a",{attrs:{href:"https://pay.weixin.qq.com/doc/v3/merchant/4012716430",target:"_blank",rel:"noopener noreferrer"}},[t._v("《微信转账 —— JSAPI 调起用户确认收款》"),e("OutboundLink")],1),t._v(" 文档，这非常重要。相比支付宝转账来说，微信转账多了一个步骤，需要用户确认收款。")]),t._v(" "),e("p",[t._v("ps：没错，微信转账真的会复杂一些，需要前置阅读比较多的东西，才能跑通！！！我也开发了好几天，一度想放弃，但是还是坚持下来了！！！简直是太不容易了！！！")])]),t._v(" "),e("p",[t._v("本小节，我们以商城的“分销提现”功能，大体讲解微信转账的接入流程，主要只会讲和支付宝转账不同的地方。")]),t._v(" "),e("p",[t._v("这里，使用微信小程序作为演示，其实微信公众号也是类似的。")]),t._v(" "),e("h2",{attrs:{id:"_1-【用户】申请商城分佣提现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-【用户】申请商城分佣提现"}},[t._v("#")]),t._v(" 1.【用户】申请商城分佣提现")]),t._v(" "),e("p",[t._v("在商城 uniapp 微信小程序中，申请分佣提现，如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E6%94%AF%E4%BB%98%E6%89%8B%E5%86%8C/%E5%BE%AE%E4%BF%A1%E8%BD%AC%E8%B4%A6%E6%8E%A5%E5%85%A5/%E7%94%B3%E8%AF%B7%E5%88%86%E4%BD%A3%E6%8F%90%E7%8E%B0.png",alt:"申请分佣提现"}})]),t._v(" "),e("p",[t._v("注意，需要选择“微信零钱”提现方式，并且最小金额是 0.3 元。")]),t._v(" "),e("p",[t._v("ps：这一部，不涉及到 PayTransferAPI 的调用，只是商城的 "),e("code",[t._v("trade_brokerage_withdraw")]),t._v(" 表的插入操作。")]),t._v(" "),e("h3",{attrs:{id:"_2-【管理员】通过商城分佣提现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-【管理员】通过商城分佣提现"}},[t._v("#")]),t._v(" 2.【管理员】通过商城分佣提现")]),t._v(" "),e("p",[t._v("在商城后台，点击该分佣提现的【通过】按钮，如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E6%94%AF%E4%BB%98%E6%89%8B%E5%86%8C/%E5%BE%AE%E4%BF%A1%E8%BD%AC%E8%B4%A6%E6%8E%A5%E5%85%A5/%E9%80%9A%E8%BF%87%E5%88%86%E4%BD%A3%E6%8F%90%E7%8E%B0.png",alt:"通过分佣提现"}})]),t._v(" "),e("p",[t._v("此时，商城后端会调用 PayTransferAPI 的 "),e("code",[t._v("createTransfer")]),t._v(" 方法，创建微信转账订单。它的内部，实际调用的是 "),e("a",{attrs:{href:"https://pay.weixin.qq.com/doc/v3/merchant/4012716434",target:"_blank",rel:"noopener noreferrer"}},[t._v("《微信转账 —— 发起转账》"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("具体的实现，可见 AppBrokerageWithdrawController 的 "),e("code",[t._v("#createBrokerageWithdraw(...)")]),t._v(" 方法对应的 HTTP 接口。")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("补充说明：")]),t._v(" "),e("p",[t._v("① 微信转账 API，需要去 "),e("a",{attrs:{href:"https://pay.weixin.qq.com/index.php/extend/mch_sec_ip",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://pay.weixin.qq.com/index.php/extend/mch_sec_ip"),e("OutboundLink")],1),t._v(" 配置 IP 白名单。")]),t._v(" "),e("p",[t._v("② 微信转账回调接口，即 "),e("code",[t._v("application.yaml")]),t._v(" 配置文件中的 "),e("code",[t._v("yudao.pay.transfer-notify-url")]),t._v(" 配置项，必须是 https 协议，否则会报错。")])]),t._v(" "),e("h3",{attrs:{id:"_3-【用户】确认收款"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-【用户】确认收款"}},[t._v("#")]),t._v(" 3.【用户】确认收款")]),t._v(" "),e("p",[t._v("在商城 uniapp 微信小程序中，点击该分佣提现的【确认收款】按钮，如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/img/%E6%94%AF%E4%BB%98%E6%89%8B%E5%86%8C/%E5%BE%AE%E4%BF%A1%E8%BD%AC%E8%B4%A6%E6%8E%A5%E5%85%A5/%E7%A1%AE%E8%AE%A4%E6%94%B6%E6%AC%BE.jpg",alt:"确认收款"}})]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("补充说明：")]),t._v(" "),e("p",[t._v("这里必须使用微信开发者工具的真机模拟，因为微信电脑模拟器，无法调起确认收款流程。")])]),t._v(" "),e("p",[t._v("此时，商城 uniapp 会调用微信小程序提供的 requestMerchantTransfer 方法，确认收款。它的内部，实现调用的是 "),e("a",{attrs:{href:"https://pay.weixin.qq.com/doc/v3/merchant/4012716430",target:"_blank",rel:"noopener noreferrer"}},[t._v("《微信转账 —— JSAPI 调起用户确认收款》"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("具体的实现，可见商城 uniapp 项目的 "),e("code",[t._v("pages/commission/wallet.vue")]),t._v(" 界面的 "),e("code",[t._v("#onRequestMerchantTransfer(...)")]),t._v(" 方法。")])])}),[],!1,null,null,null);e.default=_.exports}}]);